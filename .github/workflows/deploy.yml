name: Deploy to GCP VM

on:
  push:
    branches:
      - develop    # Deploy to staging
      - main       # Deploy to production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ===============================================
      # 1. PR√âPARATION
      # ===============================================
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ===============================================
      # 2. TESTS ET BUILD
      # ===============================================
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
        continue-on-error: true
      
      - name: Build TypeScript
        run: npm run build
      
      # ===============================================
      # 3. D√âTERMINER L'ENVIRONNEMENT
      # ===============================================
      - name: Set environment variables
        run: |
          # Nom du service depuis le repository
          SERVICE_NAME="ptk-clients-api"
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_ENV
          echo "DATE_TAG=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "CONTAINER_SUFFIX=prod" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "CONTAINER_SUFFIX=staging" >> $GITHUB_ENV
          fi
          
          echo "üîç Service: $SERVICE_NAME"
          echo "üåç Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"
      
      # ===============================================
      # 4. BUILD ET PUSH DOCKER IMAGE
      # ===============================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.SERVICE_NAME }}"
          
          # Tags pour versioning
          TAG_ENV="${{ env.ENVIRONMENT }}"
          TAG_SHA="${{ env.ENVIRONMENT }}-${{ env.SHORT_SHA }}"
          TAG_DATE="${{ env.ENVIRONMENT }}-${{ env.DATE_TAG }}"
          TAG_LATEST="${{ env.ENVIRONMENT }}-latest"
          
          echo "üê≥ Building image: $IMAGE_NAME"
          echo "üè∑Ô∏è Tags: $TAG_ENV, $TAG_SHA, $TAG_DATE, $TAG_LATEST"
          
          # Build l'image
          docker build -t $IMAGE_NAME:$TAG_ENV .
          
          # Ajouter tous les tags
          docker tag $IMAGE_NAME:$TAG_ENV $IMAGE_NAME:$TAG_SHA
          docker tag $IMAGE_NAME:$TAG_ENV $IMAGE_NAME:$TAG_DATE
          docker tag $IMAGE_NAME:$TAG_ENV $IMAGE_NAME:$TAG_LATEST
          
          # Push tous les tags
          docker push $IMAGE_NAME:$TAG_ENV
          docker push $IMAGE_NAME:$TAG_SHA
          docker push $IMAGE_NAME:$TAG_DATE
          docker push $IMAGE_NAME:$TAG_LATEST
          
          echo "‚úÖ Image pushed: $IMAGE_NAME:$TAG_ENV"
      
      # ===============================================
      # 5. AUTHENTIFICATION GCP
      # ===============================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      # ===============================================
      # 6. D√âPLOIEMENT SUR VM GCP
      # ===============================================
      - name: Deploy to GCP VM
        run: |
          # Cr√©er le script de d√©ploiement
          cat > deploy-script.sh << 'EOF'
          #!/bin/bash
          set -e
          
          SERVICE_NAME="${{ env.SERVICE_NAME }}"
          ENVIRONMENT="${{ env.ENVIRONMENT }}"
          CONTAINER_SUFFIX="${{ env.CONTAINER_SUFFIX }}"
          DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          IMAGE_TAG="${{ env.ENVIRONMENT }}-${{ env.SHORT_SHA }}"
          
          echo "üöÄ Deploying $SERVICE_NAME to $ENVIRONMENT"
          echo "üì¶ Image: $DOCKER_USERNAME/$SERVICE_NAME:$IMAGE_TAG"
          
          # Aller dans le r√©pertoire du projet
          cd /opt/payetonkawa
          
          # Pull de la nouvelle image
          echo "‚¨áÔ∏è Pulling new image..."
          sudo docker pull $DOCKER_USERNAME/$SERVICE_NAME:$IMAGE_TAG
          
          # Tag comme environment pour docker-compose
          sudo docker tag $DOCKER_USERNAME/$SERVICE_NAME:$IMAGE_TAG $DOCKER_USERNAME/$SERVICE_NAME:$ENVIRONMENT
          
          # Identifier le service √† red√©marrer
          COMPOSE_SERVICE="clients-api-$CONTAINER_SUFFIX"
          
          echo "üîÑ Restarting service: $COMPOSE_SERVICE"
          
          # Mettre √† jour le .env avec la nouvelle image
          sudo sed -i "s|DOCKER_REGISTRY=.*|DOCKER_REGISTRY=$DOCKER_USERNAME|g" .env
          
          # Arr√™ter et supprimer le container existant
          sudo docker-compose stop $COMPOSE_SERVICE || true
          sudo docker-compose rm -f $COMPOSE_SERVICE || true
          
          # Red√©marrer avec la nouvelle image
          sudo docker-compose up -d $COMPOSE_SERVICE
          
          # Attendre que le service soit pr√™t
          echo "‚è≥ Waiting for service to be ready..."
          sleep 30
          
          # Health check sur le port appropri√©
          if [ "$ENVIRONMENT" = "production" ]; then
            HEALTH_PORT="4001"
          else
            HEALTH_PORT="3001"
          fi
          
          echo "üè• Health check on port $HEALTH_PORT"
          
          # Tenter le health check (plusieurs essais)
          for i in {1..5}; do
            if curl -f http://localhost:$HEALTH_PORT/health 2>/dev/null; then
              echo "‚úÖ Service $COMPOSE_SERVICE is healthy!"
              break
            elif [ $i -eq 5 ]; then
              echo "‚ö†Ô∏è Health check failed, but service might still be starting"
              echo "üìã Container status:"
              sudo docker ps | grep $COMPOSE_SERVICE || echo "Container not found"
              sudo docker-compose logs --tail=20 $COMPOSE_SERVICE || echo "No logs available"
            else
              echo "‚è≥ Attempt $i/5 failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          # Nettoyer les anciennes images (garder les 5 derni√®res)
          echo "üßπ Cleaning old images..."
          sudo docker images $DOCKER_USERNAME/$SERVICE_NAME --format "table {{.Tag}}\t{{.CreatedAt}}" | grep -v TAG | sort -k2 -r | tail -n +6 | awk '{print "'$DOCKER_USERNAME'/'$SERVICE_NAME':"$1}' | xargs -r sudo docker rmi || true
          
          echo "üéâ Deployment completed!"
          EOF
          
          # Rendre le script ex√©cutable
          chmod +x deploy-script.sh
          
          # Copier et ex√©cuter sur la VM via gcloud
          echo "üì° Connecting to VM ${{ secrets.GCP_VM_NAME }}..."
          
          # Copier le script sur la VM
          gcloud compute scp deploy-script.sh ${{ secrets.GCP_VM_NAME }}:/tmp/ \
            --zone=${{ secrets.GCP_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          # Ex√©cuter le script sur la VM
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --command="chmod +x /tmp/deploy-script.sh && /tmp/deploy-script.sh"
      
      # ===============================================
      # 7. NOTIFICATIONS
      # ===============================================
      - name: Deployment success notification
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "üì¶ Service: ${{ env.SERVICE_NAME }}"
          echo "üåç Environment: ${{ env.ENVIRONMENT }}"
          echo "üè∑Ô∏è Image: ${{ secrets.DOCKER_USERNAME }}/${{ env.SERVICE_NAME }}:${{ env.ENVIRONMENT }}-${{ env.SHORT_SHA }}"
          
          if [ "${{ env.ENVIRONMENT }}" = "production" ]; then
            URL="http://${{ secrets.VM_EXTERNAL_IP }}/api/clients"
          else
            URL="http://${{ secrets.VM_EXTERNAL_IP }}/staging/api/clients"
          fi
          
          echo "üîó API URL: $URL"
      
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "üì¶ Service: ${{ env.SERVICE_NAME }}"
          echo "üåç Environment: ${{ env.ENVIRONMENT }}"
          echo "üîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"